'use strict';

var FIREBASE_URL = 'https://c9auth.firebaseio.com/';
var fb = new Firebase(FIREBASE_URL);
var initLoad = true;

$('.onLoggedIn form').submit(function () {
  var url = $('.onLoggedIn input[type="url"]').val();
  var uid = fb.getAuth().uid;
  var token = fb.getAuth().token;
  var postUrl = '' + FIREBASE_URL + '/users/' + uid + '/fotos.json?auth=' + token;

  $.post(postUrl, JSON.stringify(url), function (res) {
    addPhotosToDom({ url: url });
    clearForms();
    // res = { name: '-Jk4dfDd123' }
  });

  event.preventDefault();
});

$('.onTempPassword form').submit(function () {
  var email = fb.getAuth().password.email;
  var oldPw = $('.onTempPassword input:nth-child(1)').val();
  var newPw = $('.onTempPassword input:nth-child(2)').val();

  fb.changePassword({
    email: email,
    oldPassword: oldPw,
    newPassword: newPw
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      fb.unauth();
    }
  });

  event.preventDefault();
});

$('.doResetPassword').click(function () {
  var email = $('.onLoggedOut input[type="email"]').val();

  fb.resetPassword({
    email: email
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      alert('Check your email!');
    }
  });
});

$('.doLogout').click(function () {
  fb.unauth(function () {
    window.location.reload();
  });
});

$('.doRegister').click(function () {
  var email = $('.onLoggedOut input[type="email"]').val();
  var password = $('.onLoggedOut input[type="password"]').val();

  fb.createUser({
    email: email,
    password: password
  }, function (err, userData) {
    if (err) {
      alert(err.toString());
    } else {
      clearForms();
      doLogin(email, password, function () {
        window.location.reload();
      });
    }
  });

  event.preventDefault();
});

$('.onLoggedOut form').submit(function () {
  var email = $('.onLoggedOut input[type="email"]').val();
  var password = $('.onLoggedOut input[type="password"]').val();

  doLogin(email, password, function () {
    window.location.reload();
  });
  event.preventDefault();
});

function clearForms() {
  $('input[type="text"], input[type="email"], input[type="password"], input[type="url"]').val('');
}

function saveAuthData(authData) {
  $.ajax({
    method: 'PUT',
    url: '' + FIREBASE_URL + '/users/' + authData.uid + '/profile.json?auth=' + authData.token,
    data: JSON.stringify(authData)
  });
}

function doLogin(email, password, cb) {
  fb.authWithPassword({
    email: email,
    password: password
  }, function (err, authData) {
    if (err) {
      alert(err.toString());
    } else {
      saveAuthData(authData);
      typeof cb === 'function' && cb(authData);
    }
  });
}

function getUserData(cb) {
  var uid = fb.getAuth().uid;
  var token = fb.getAuth().token;
  var getUrl = '' + FIREBASE_URL + '/users/' + uid + '/fotos.json?auth=' + token;
  $.get(getUrl, cb);
}

function addPhotosToDom(photos) {
  if (photos) {
    Object.keys(photos).forEach(function (uuid) {
      $('<img src="' + photos[uuid] + '" data-uid="' + uuid + '">').appendTo($('.favFotos'));
    });
  }
}

fb.onAuth(function (authData) {
  if (initLoad) {
    var onLoggedOut = $('.onLoggedOut');
    var onLoggedIn = $('.onLoggedIn');
    var onTempPassword = $('.onTempPassword');

    if (authData && authData.password.isTemporaryPassword) {
      // temporary log in
      onTempPassword.removeClass('hidden');
      onLoggedIn.addClass('hidden');
      onLoggedOut.addClass('hidden');
    } else if (authData) {
      // logged in
      onLoggedIn.removeClass('hidden');
      onLoggedOut.addClass('hidden');
      onTempPassword.addClass('hidden');
      $('.onLoggedIn h1').text('Hello ' + authData.password.email);
      getUserData(function (urls) {
        addPhotosToDom(urls);
      });
    } else {
      // on logged out
      onLoggedOut.removeClass('hidden');
      onLoggedIn.addClass('hidden');
      onTempPassword.addClass('hidden');
    }

    clearForms();
  }

  initLoad = false;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9qcy9maXJlYmFzZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBRWIsSUFBSSxZQUFZLEdBQUcsZ0NBQWdDLENBQUM7QUFDcEQsSUFBSSxFQUFFLEdBQUcsSUFBSSxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDcEMsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDOztBQUVwQixDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWTtBQUN2QyxNQUFJLEdBQUcsR0FBRyxDQUFDLENBQUMsK0JBQStCLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUNuRCxNQUFJLEdBQUcsR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxDQUFDO0FBQzNCLE1BQUksS0FBSyxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUM7QUFDL0IsTUFBSSxPQUFPLFFBQU0sWUFBWSxlQUFVLEdBQUcseUJBQW9CLEtBQUssQUFBRSxDQUFDOztBQUd0RSxHQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFLFVBQVUsR0FBRyxFQUFFO0FBQ2xELGtCQUFjLENBQUMsRUFBQyxHQUFHLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQztBQUMzQixjQUFVLEVBQUUsQ0FBQzs7R0FFZCxDQUFDLENBQUM7O0FBRUgsT0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO0NBQ3hCLENBQUMsQ0FBQTs7QUFFRixDQUFDLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWTtBQUMzQyxNQUFJLEtBQUssR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztBQUN4QyxNQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsb0NBQW9DLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUMxRCxNQUFJLEtB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QUM5QixvQkFBYyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztLQUNuQzs7QUFFRixjQUFVLEVBQUUsQ0FBQztHQUNiOztBQUVELFVBQVEsR0FBRyxLQUFLLENBQUM7Q0FDbEIsQ0FBQyxDQUFDIiwiZmlsZSI6ImZpcmViYXNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgRklSRUJBU0VfVVJMID0gJ2h0dHBzOi8vYzlhdXRoLmZpcmViYXNlaW8uY29tLyc7XG52YXIgZmIgPSBuZXcgRmlyZWJhc2UoRklSRUJBU0VfVVJMKTtcbnZhciBpbml0TG9hZCA9IHRydWU7XG5cbiQoJy5vbkxvZ2dlZEluIGZvcm0nKS5zdWJtaXQoZnVuY3Rpb24gKCkge1xuICB2YXIgdXJsID0gJCgnLm9uTG9nZ2VkSW4gaW5wdXRbdHlwZT1cInVybFwiXScpLnZhbCgpO1xuICB2YXIgdWlkID0gZmIuZ2V0QXV0aCgpLnVpZDtcbiAgdmFyIHRva2VuID0gZmIuZ2V0QXV0aCgpLnRva2VuO1xuICB2YXIgcG9zdFVybCA9IGAke0ZJUkVCQVNFX1VSTH0vdXNlcnMvJHt1aWR9L2ZvdG9zLmpzb24/YXV0aD0ke3Rva2VufWA7XG5cblxuICAkLnBvc3QocG9zdFVybCwgSlNPTi5zdHJpbmdpZnkodXJsKSwgZnVuY3Rpb24gKHJlcykge1xuICAgIGFkZFBob3Rvc1RvRG9tKHt1cmw6IHVybH0pO1xuICAgIGNsZWFyRm9ybXMoKTtcbiAgICAvLyByZXMgPSB7IG5hbWU6ICctSms0ZGZEZDEyMycgfVxuICB9KTtcblxuICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xufSlcblxuJCgnLm9uVGVtcFBhc3N3b3JkIGZvcm0nKS5zdWJtaXQoZnVuY3Rpb24gKCkge1xuICB2YXIgZW1haWwgPSBmYi5nZXRBdXRoKCkucGFzc3dvcmQuZW1haWw7XG4gIHZhciBvbGRQdyA9ICQoJy5vblRlbXBQYXNzd29yZCBpbnB1dDpudGgtY2hpbGQoMSknKS52YWwoKTtcbiAgdmFyIG5ld1B3ID0gJCgnLm9uVGVtcFBhc3N3b3JkIGlucHV0Om50aC1jaGlsZCgyKScpLnZhbCgpO1xuXG4gIGZiLmNoYW5nZVBhc3N3b3JkKHtcbiAgICBlbWFpbDogZW1haWwsXG4gICAgb2xkUGFzc3dvcmQ6IG9sZFB3LFxuICAgIG5ld1Bhc3N3b3JkOiBuZXdQd1xuICB9LCBmdW5jdGlvbihlcnIpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBhbGVydChlcnIudG9TdHJpbmcoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZiLnVuYXV0aCgpO1xuICAgIH1cbiAgfSk7XG5cbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbn0pXG5cbiQoJy5kb1Jlc2V0UGFzc3dvcmQnKS5jbGljayhmdW5jdGlvbiAoKSB7XG4gIHZhciBlbWFpbCA9ICQoJy5vbkxvZ2dlZE91dCBpbnB1dFt0eXBlPVwiZW1haWxcIl0nKS52YWwoKTtcblxuICBmYi5yZXNldFBhc3N3b3JkKHtcbiAgICBlbWFpbDogZW1haWxcbiAgfSwgZnVuY3Rpb24gKGVycikge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGFsZXJ0KGVyci50b1N0cmluZygpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYWxlcnQoJ0NoZWNrIHlvdXIgZW1haWwhJyk7XG4gICAgfVxuICB9KTtcbn0pO1xuXG4kKCcuZG9Mb2dvdXQnKS5jbGljayhmdW5jdGlvbiAoKSB7XG4gIGZiLnVuYXV0aChmdW5jdGlvbiAoKSB7XG4gICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICB9KTtcbn0pXG5cbiQoJy5kb1JlZ2lzdGVyJykuY2xpY2soZnVuY3Rpb24gKCkge1xuICB2YXIgZW1haWwgPSAkKCcub25Mb2dnZWRPdXQgaW5wdXRbdHlwZT1cImVtYWlsXCJdJykudmFsKCk7XG4gIHZhciBwYXNzd29yZCA9ICQoJy5vbkxvZ2dlZE91dCBpbnB1dFt0eXBlPVwicGFzc3dvcmRcIl0nKS52YWwoKTtcblxuICBmYi5jcmVhdGVVc2VyKHtcbiAgICBlbWFpbDogZW1haWwsXG4gICAgcGFzc3dvcmQ6IHBhc3N3b3JkXG4gIH0sIGZ1bmN0aW9uIChlcnIsIHVzZXJEYXRhKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgYWxlcnQoZXJyLnRvU3RyaW5nKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjbGVhckZvcm1zKCk7XG4gICAgICBkb0xvZ2luKGVtYWlsLCBwYXNzd29yZCwgZnVuY3Rpb24gKCkge1xuICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG59KTtcblxuJCgnLm9uTG9nZ2VkT3V0IGZvcm0nKS5zdWJtaXQoZnVuY3Rpb24gKCkge1xuICB2YXIgZW1haWwgPSAkKCcub25Mb2dnZWRPdXQgaW5wdXRbdHlwZT1cImVtYWlsXCJdJykudmFsKCk7XG4gIHZhciBwYXNzd29yZCA9ICQoJy5vbkxvZ2dlZE91dCBpbnB1dFt0eXBlPVwicGFzc3dvcmRcIl0nKS52YWwoKTtcblxuICBkb0xvZ2luKGVtYWlsLCBwYXNzd29yZCwgZnVuY3Rpb24gKCkge1xuICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTtcbiAgfSk7XG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG59KTtcblxuZnVuY3Rpb24gY2xlYXJGb3JtcyAoKSB7XG4gICQoJ2lucHV0W3R5cGU9XCJ0ZXh0XCJdLCBpbnB1dFt0eXBlPVwiZW1haWxcIl0sIGlucHV0W3R5cGU9XCJwYXNzd29yZFwiXSwgaW5wdXRbdHlwZT1cInVybFwiXScpLnZhbCgnJyk7XG59XG5cbmZ1bmN0aW9uIHNhdmVBdXRoRGF0YSAoYXV0aERhdGEpIHtcbiAgJC5hamF4KHtcbiAgICBtZXRob2Q6ICdQVVQnLFxuICAgIHVybDogYCR7RklSRUJBU0VfVVJMfS91c2Vycy8ke2F1dGhEYXRhLnVpZH0vcHJvZmlsZS5qc29uP2F1dGg9JHthdXRoRGF0YS50b2tlbn1gLFxuICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KGF1dGhEYXRhKVxuICB9KTtcbn1cblxuZnVuY3Rpb24gZG9Mb2dpbiAoZW1haWwsIHBhc3N3b3JkLCBjYikge1xuICBmYi5hdXRoV2l0aFBhc3N3b3JkKHtcbiAgICBlbWFpbDogZW1haWwsXG4gICAgcGFzc3dvcmQ6IHBhc3N3b3JkXG4gIH0sIGZ1bmN0aW9uIChlcnIsIGF1dGhEYXRhKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgYWxlcnQoZXJyLnRvU3RyaW5nKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzYXZlQXV0aERhdGEoYXV0aERhdGEpO1xuICAgICAgdHlwZW9mIGNiID09PSAnZnVuY3Rpb24nICYmIGNiKGF1dGhEYXRhKTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBnZXRVc2VyRGF0YSAoY2IpIHtcbiAgdmFyIHVpZCA9IGZiLmdldEF1dGgoKS51aWQ7XG4gIHZhciB0b2tlbiA9IGZiLmdldEF1dGgoKS50b2tlbjtcbiAgdmFyIGdldFVybCA9IGAke0ZJUkVCQVNFX1VSTH0vdXNlcnMvJHt1aWR9L2ZvdG9zLmpzb24/YXV0aD0ke3Rva2VufWA7XG4gICQuZ2V0KGdldFVybCwgY2IpO1xufVxuXG5mdW5jdGlvbiBhZGRQaG90b3NUb0RvbSAocGhvdG9zKSB7XG4gIGlmIChwaG90b3MpIHtcbiAgICBPYmplY3Qua2V5cyhwaG90b3MpLmZvckVhY2goZnVuY3Rpb24gKHV1aWQpe1xuICAgIFx0JChgPGltZyBzcmM9XCIke3Bob3Rvc1t1dWlkXX1cIiBkYXRhLXVpZD1cIiR7dXVpZH1cIj5gKS5hcHBlbmRUbygkKCcuZmF2Rm90b3MnKSk7XG4gIFx0fSlcbiAgfVxufVxuXG5mYi5vbkF1dGgoZnVuY3Rpb24gKGF1dGhEYXRhKSB7XG4gIGlmIChpbml0TG9hZCkge1xuICAgIHZhciBvbkxvZ2dlZE91dCA9ICQoJy5vbkxvZ2dlZE91dCcpO1xuICAgIHZhciBvbkxvZ2dlZEluID0gJCgnLm9uTG9nZ2VkSW4nKTtcbiAgICB2YXIgb25UZW1wUGFzc3dvcmQgPSAkKCcub25UZW1wUGFzc3dvcmQnKTtcblxuICAgIGlmIChhdXRoRGF0YSAmJiBhdXRoRGF0YS5wYXNzd29yZC5pc1RlbXBvcmFyeVBhc3N3b3JkKSB7XG4gICAgICAvLyB0ZW1wb3JhcnkgbG9nIGluXG4gICAgICBvblRlbXBQYXNzd29yZC5yZW1vdmVDbGFzcygnaGlkZGVuJyk7XG4gICAgICBvbkxvZ2dlZEluLmFkZENsYXNzKCdoaWRkZW4nKTtcbiAgICAgIG9uTG9nZ2VkT3V0LmFkZENsYXNzKCdoaWRkZW4nKTtcbiAgICB9IGVsc2UgaWYgKGF1dGhEYXRhKSB7XG4gICAgICAvLyBsb2dnZWQgaW5cbiAgICAgIG9uTG9nZ2VkSW4ucmVtb3ZlQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgb25Mb2dnZWRPdXQuYWRkQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgb25UZW1wUGFzc3dvcmQuYWRkQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgJCgnLm9uTG9nZ2VkSW4gaDEnKS50ZXh0KGBIZWxsbyAke2F1dGhEYXRhLnBhc3N3b3JkLmVtYWlsfWApO1xuICAgICAgZ2V0VXNlckRhdGEoZnVuY3Rpb24gKHVybHMpIHtcbiAgICAgICAgYWRkUGhvdG9zVG9Eb20odXJscyk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gb24gbG9nZ2VkIG91dFxuICAgICAgb25Mb2dnZWRPdXQucmVtb3ZlQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgb25Mb2dnZWRJbi5hZGRDbGFzcygnaGlkZGVuJyk7XG4gICAgICBvblRlbXBQYXNzd29yZC5hZGRDbGFzcygnaGlkZGVuJyk7XG4gICAgfVxuXG4gIFx0Y2xlYXJGb3JtcygpO1xuICB9XG5cbiAgaW5pdExvYWQgPSBmYWxzZTtcbn0pO1xuIl19
