'use strict';

var FIREBASE_URL = 'https://c9auth.firebaseio.com/';
var fb = new Firebase(FIREBASE_URL);
var initLoad = true;

$('.onLoggedIn form').submit(function () {
  var url = $('.onLoggedIn input[type="url"]').val();
  var uid = fb.getAuth().uid;
  var token = fb.getAuth().token;
  var postUrl = '' + FIREBASE_URL + '/users/' + uid + '/fotos.json?auth=' + token;

  $.post(postUrl, JSON.stringify(url), function (res) {
    addPhotosToDom({ url: url });
    clearForms();
    // res = { name: '-Jk4dfDd123' }
  });

  event.preventDefault();
});

$('.onTempPassword form').submit(function () {
  var email = fb.getAuth().password.email;
  var oldPw = $('.onTempPassword input:nth-child(1)').val();
  var newPw = $('.onTempPassword input:nth-child(2)').val();

  fb.changePassword({
    email: email,
    oldPassword: oldPw,
    newPassword: newPw
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      fb.unauth();
    }
  });

  event.preventDefault();
});

$('.doResetPassword').click(function () {
  var email = $('.onLoggedOut input[type="email"]').val();

  fb.resetPassword({
    email: email
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      alert('Check your email!');
    }
  });
});

$('.doLogout').click(function () {
  fb.unauth(function () {
    window.location.reload();
  });
});

$('.doRegister').click(function () {
  var email = $('.onLoggedOut input[type="email"]').val();
  var password = $('.onLoggedOut input[type="password"]').val();

  fb.createUser({
    email: email,
    password: password
  }, function (err, userData) {
    if (err) {
      alert(err.toString());
    } else {
      clearForms();
      doLogin(email, password, function () {
        window.location.reload();
      });
    }
  });

  event.preventDefault();
});

$('.onLoggedOut form').submit(function () {
  var email = $('.onLoggedOut input[type="email"]').val();
  var password = $('.onLoggedOut input[type="password"]').val();

  doLogin(email, password, function () {
    window.location.reload();
  });
  event.preventDefault();
});

function clearForms() {
  $('input[type="text"], input[type="email"], input[type="password"], input[type="url"]').val('');
}

function saveAuthData(authData) {
  $.ajax({
    method: 'PUT',
    url: '' + FIREBASE_URL + '/users/' + authData.uid + '/profile.json?auth=' + authData.token,
    data: JSON.stringify(authData)
  });
}

function doLogin(email, password, cb) {
  fb.authWithPassword({
    email: email,
    password: password
  }, function (err, authData) {
    if (err) {
      alert(err.toString());
    } else {
      saveAuthData(authData);
      typeof cb === 'function' && cb(authData);
    }
  });
}

function getUserData(cb) {
  var uid = fb.getAuth().uid;
  var token = fb.getAuth().token;
  var getUrl = '' + FIREBASE_URL + '/users/' + uid + '/fotos.json?auth=' + token;
  $.get(getUrl, cb);
}

function addPhotosToDom(photos) {
  if (photos) {
    Object.keys(photos).forEach(function (uuid) {
      $('<img src="' + photos[uuid] + '" data-uid="' + uuid + '">').appendTo($('.favFotos'));
    });
  }
}

fb.onAuth(function (authData) {
  if (initLoad) {
    var onLoggedOut = $('.onLoggedOut');
    var onLoggedIn = $('.onLoggedIn');
    var onTempPassword = $('.onTempPassword');

    if (authData && authData.password.isTemporaryPassword) {
      // temporary log in
      onTempPassword.removeClass('hidden');
      onLoggedIn.addClass('hidden');
      onLoggedOut.addClass('hidden');
    } else if (authData) {
      // logged in
      onLoggedIn.removeClass('hidden');
      onLoggedOut.addClass('hidden');
      onTempPassword.addClass('hidden');
      $('.onLoggedIn h1').text('Hello ' + authData.password.email);
      getUserData(function (urls) {
        addPhotosToDom(urls);
      });
    } else {
      // on logged out
      onLoggedOut.removeClass('hidden');
      onLoggedIn.addClass('hidden');
      onTempPassword.addClass('hidden');
    }

    clearForms();
  }

  initLoad = false;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9qcy9maXJlYmFzZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBRWIsSUFBSSxZQUFZLEdBQUcsZ0NBQWdDLENBQUM7QUFDcEQsSUFBSSxFQUFFLEdBQUcsSUFBSSxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDcEMsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDOztBQUVwQixDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWTtBQUN2QyxNQUFJLEdBQUcsR0FBRyxDQUFDLENBQUMsK0JBQStCLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUNuRCxNQUFJLEdBQUcsR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxDQUFDO0FBQzNCLE1BQUksS0FBSyxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUM7QUFDL0IsTUFBSSxPQUFPLFFBQU0sWUFBWSxlQUFVLEdBQUcseUJBQW9CLEtBQUssQUFBRSxDQUFDOztBQUd0RSxHQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFLFVBQVUsR0FBRyxFQUFFO0FBQ2xELGtCQUFjLENBQUMsRUFBQyxHQUFHLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQztBQUMzQixjQUFVLEVBQUUsQ0FBQzs7R0FFZCxDQUFDLENBQUM7O0FBRUgsT0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO0NBQ3hCLENBQUMsQ0FBQTs7QUFFRixDQUFDLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWTtBQUMzQyxNQUFJLEtBQUssR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztBQUN4QyxNQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsb0NBQW9DLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUMxRCxNQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsb0NBQW9DLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQzs7QUFFMUQsSUFBRSxDQUFDLGNBQWMsQ0FBQztBQUNoQixTQUFLLEVBQUUsS0FBSztBQUNaLGVBQVcsRUFBRSxLQUFLO0FBQ2xCLGVBQVcsRUFBRSxLQUFLO0dBQ25CLEVBQUUsVUFBUyxHQUFHLEVBQUU7QUFDZixRQUFJLEdBQUcsRUFBRTtBQUNQLFdBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztLQUN2QixNQUFNO0FBQ0wsUUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDO0tBQ2I7R0FDRixDQUFDLENBQUM7O0FBRUgsT0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO0NBQ3hCLENBQUMsQ0FBQTs7QUFFRixDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxLQUFLLENBQUMsWUFBWTtBQUN0QyxNQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsa0NBQWtDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQzs7QUFFeEQsSUFBRSxDQUFDLGFBQWEsQ0FBQztBQUNmLFNBQUssRUFBRSxLQUFLO0dBQ2IsRUFBRSxVQUFVLEdBQUcsRUFBRTtBQUNoQixRQUFJLEdBQUcsRUFBRTtBQUNQLFdBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztLQUN2QixNQUFNO0FBQ0wsV0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7S0FDNUI7R0FDRixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUM7O0FBRUgsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZO0FBQy9CLElBQUUsQ0FBQyxNQUFNLENBQUMsWUFBWTtBQUNwQixVQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO0dBQzFCLENBQUMsQ0FBQztDQUNKLENBQUMsQ0FBQTs7QUFFRixDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsS0FBSyxDQUFDLFlBQVk7QUFDakMsTUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDLGtDQUFrQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDeEQsTUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDLHFDQUFxQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7O0FBRTlELElBQUUsQ0FBQyxVQUFVLENBQUM7QUFDWixTQUFLLEVBQUUsS0FBSztBQUNaLFlBQVEsRUFBRSxRQUFRO0dBQ25CLEVBQUUsVUFBVSxHQUFHLEVBQUUsUUFBUSxFQUFFO0FBQzFCLFFBQUksR0FBRyxFQUFFO0FBQ1AsV0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0tBQ3ZCLE1BQU07QUFDTCxnQkFBVSxFQUFFLENBQUM7QUFDYixhQUFPLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxZQUFZO0FBQ25DLGNBQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7T0FDMUIsQ0FBQyxDQUFDO0tBQ0o7R0FDRixDQUFDLENBQUM7O0FBRUgsT0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO0NBQ3hCLENBQUMsQ0FBQzs7QUFFSCxDQUFDLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWTtBQUN4QyxNQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsa0NBQWtDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUN4RCxNQUFJLFFBQVEsR0FBRyxDQUFDLENBQUMscUNBQXFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQzs7QUFFOUQsU0FBTyxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsWUFBWTtBQUNuQyxVQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO0dBQzFCLENBQUMsQ0FBQztBQUNILE9BQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztDQUN4QixDQUFDLENBQUM7O0FBRUgsU0FBUyxVQUFVLEdBQUk7QUFDckIsR0FBQyxDQUFDLG9GQUFvRixDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0NBQ2pHOztBQUVELFNBQVMsWUFBWSxDQUFFLFFBQVEsRUFBRTtBQUMvQixHQUFDLENBQUMsSUFBSSxDQUFDO0FBQ0wsVUFBTSxFQUFFLEtBQUs7QUFDYixPQUFHLE9BQUssWUFBWSxlQUFVLFFBQVEsQ0FBQyxHQUFHLDJCQUFzQixRQUFRLENBQUMsS0FBSyxBQUFFO0FBQ2hGLFFBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztHQUMvQixDQUFDLENBQUM7Q0FDSjs7QUFFRCxTQUFTLE9BQU8sQ0FBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRTtBQUNyQyxJQUFFLENBQUMsZ0JBQWdCLENBQUM7QUFDbEIsU0FBSyxFQUFFLEtBQUs7QUFDWixZQUFRLEVBQUUsUUFBUTtHQUNuQixFQUFFLFVBQVUsR0FBRyxFQUFFLFFBQVEsRUFBRTtBQUMxQixRQUFJLEdBQUcsRUFBRTtBQUNQLFdBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztLQUN2QixNQUFNO0FBQ0wsa0JBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN2QixhQUFPLEVBQUUsS0FBSyxVQUFVLElBQUksRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQzFDO0dBQ0YsQ0FBQyxDQUFDO0NBQ0o7O0FBRUQsU0FBUyxXQUFXLENBQUUsRUFBRSxFQUFFO0FBQ3hCLE1BQUksR0FBRyxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLENBQUM7QUFDM0IsTUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQztBQUMvQixNQUFJLE1BQU0sUUFBTSxZQUFZLGVBQVUsR0FBRyx5QkFBb0IsS0FBSyxBQUFFLENBQUM7QUFDckUsR0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7Q0FDbkI7O0FBRUQsU0FBUyxjQUFjLENBQUUsTUFBTSxFQUFFO0FBQy9CLE1BQUksTUFBTSxFQUFFO0FBQ1YsVUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJLEVBQUM7QUFDMUMsT0FBQyxnQkFBYyxNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFlLElBQUksUUFBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztLQUM5RSxDQUFDLENBQUE7R0FDRjtDQUNGOztBQUVELEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBVSxRQUFRLEVBQUU7QUFDNUIsTUFBSSxRQUFRLEVBQUU7QUFDWixRQUFJLFdBQVcsR0FBRyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDcEMsUUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ2xDLFFBQUksY0FBYyxHQUFHLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDOztBQUUxQyxRQUFJLFFBQVEsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFOztBQUVyRCxvQkFBYyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNyQyxnQkFBVSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM5QixpQkFBVyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztLQUNoQyxNQUFNLElBQUksUUFBUSxFQUFFOztBQUVuQixnQkFBVSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNqQyxpQkFBVyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixvQkFBYyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNsQyxPQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxJQUFJLFlBQVUsUUFBUSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUcsQ0FBQztBQUM3RCxpQkFBVyxDQUFDLFVBQVUsSUFBSSxFQUFFO0FBQzFCLHNCQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7T0FDdEIsQ0FBQyxDQUFDO0tBQ0osTUFBTTs7QUFFTCxpQkFBVyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNsQyxnQkFBVSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM5QixvQkFBYyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztLQUNuQzs7QUFFRixjQUFVLEVBQUUsQ0FBQztHQUNiOztBQUVELFVBQVEsR0FBRyxLQUFLLENBQUM7Q0FDbEIsQ0FBQyxDQUFDIiwiZmlsZSI6ImZpcmViYXNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgRklSRUJBU0VfVVJMID0gJ2h0dHBzOi8vYzlhdXRoLmZpcmViYXNlaW8uY29tLyc7XG52YXIgZmIgPSBuZXcgRmlyZWJhc2UoRklSRUJBU0VfVVJMKTtcbnZhciBpbml0TG9hZCA9IHRydWU7XG5cbiQoJy5vbkxvZ2dlZEluIGZvcm0nKS5zdWJtaXQoZnVuY3Rpb24gKCkge1xuICB2YXIgdXJsID0gJCgnLm9uTG9nZ2VkSW4gaW5wdXRbdHlwZT1cInVybFwiXScpLnZhbCgpO1xuICB2YXIgdWlkID0gZmIuZ2V0QXV0aCgpLnVpZDtcbiAgdmFyIHRva2VuID0gZmIuZ2V0QXV0aCgpLnRva2VuO1xuICB2YXIgcG9zdFVybCA9IGAke0ZJUkVCQVNFX1VSTH0vdXNlcnMvJHt1aWR9L2ZvdG9zLmpzb24/YXV0aD0ke3Rva2VufWA7XG4gIFxuICBcbiAgJC5wb3N0KHBvc3RVcmwsIEpTT04uc3RyaW5naWZ5KHVybCksIGZ1bmN0aW9uIChyZXMpIHtcbiAgICBhZGRQaG90b3NUb0RvbSh7dXJsOiB1cmx9KTtcbiAgICBjbGVhckZvcm1zKCk7XG4gICAgLy8gcmVzID0geyBuYW1lOiAnLUprNGRmRGQxMjMnIH1cbiAgfSk7XG4gIFxuICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xufSlcblxuJCgnLm9uVGVtcFBhc3N3b3JkIGZvcm0nKS5zdWJtaXQoZnVuY3Rpb24gKCkge1xuICB2YXIgZW1haWwgPSBmYi5nZXRBdXRoKCkucGFzc3dvcmQuZW1haWw7XG4gIHZhciBvbGRQdyA9ICQoJy5vblRlbXBQYXNzd29yZCBpbnB1dDpudGgtY2hpbGQoMSknKS52YWwoKTtcbiAgdmFyIG5ld1B3ID0gJCgnLm9uVGVtcFBhc3N3b3JkIGlucHV0Om50aC1jaGlsZCgyKScpLnZhbCgpO1xuICBcbiAgZmIuY2hhbmdlUGFzc3dvcmQoe1xuICAgIGVtYWlsOiBlbWFpbCxcbiAgICBvbGRQYXNzd29yZDogb2xkUHcsXG4gICAgbmV3UGFzc3dvcmQ6IG5ld1B3XG4gIH0sIGZ1bmN0aW9uKGVycikge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGFsZXJ0KGVyci50b1N0cmluZygpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmIudW5hdXRoKCk7XG4gICAgfVxuICB9KTtcbiAgXG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG59KVxuXG4kKCcuZG9SZXNldFBhc3N3b3JkJykuY2xpY2soZnVuY3Rpb24gKCkge1xuICB2YXIgZW1haWwgPSAkKCcub25Mb2dnZWRPdXQgaW5wdXRbdHlwZT1cImVtYWlsXCJdJykudmFsKCk7XG4gIFxuICBmYi5yZXNldFBhc3N3b3JkKHtcbiAgICBlbWFpbDogZW1haWxcbiAgfSwgZnVuY3Rpb24gKGVycikge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGFsZXJ0KGVyci50b1N0cmluZygpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYWxlcnQoJ0NoZWNrIHlvdXIgZW1haWwhJyk7XG4gICAgfVxuICB9KTtcbn0pO1xuXG4kKCcuZG9Mb2dvdXQnKS5jbGljayhmdW5jdGlvbiAoKSB7XG4gIGZiLnVuYXV0aChmdW5jdGlvbiAoKSB7XG4gICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICB9KTtcbn0pXG5cbiQoJy5kb1JlZ2lzdGVyJykuY2xpY2soZnVuY3Rpb24gKCkge1xuICB2YXIgZW1haWwgPSAkKCcub25Mb2dnZWRPdXQgaW5wdXRbdHlwZT1cImVtYWlsXCJdJykudmFsKCk7XG4gIHZhciBwYXNzd29yZCA9ICQoJy5vbkxvZ2dlZE91dCBpbnB1dFt0eXBlPVwicGFzc3dvcmRcIl0nKS52YWwoKTtcblxuICBmYi5jcmVhdGVVc2VyKHtcbiAgICBlbWFpbDogZW1haWwsXG4gICAgcGFzc3dvcmQ6IHBhc3N3b3JkXG4gIH0sIGZ1bmN0aW9uIChlcnIsIHVzZXJEYXRhKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgYWxlcnQoZXJyLnRvU3RyaW5nKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjbGVhckZvcm1zKCk7XG4gICAgICBkb0xvZ2luKGVtYWlsLCBwYXNzd29yZCwgZnVuY3Rpb24gKCkge1xuICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuICBcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbn0pO1xuXG4kKCcub25Mb2dnZWRPdXQgZm9ybScpLnN1Ym1pdChmdW5jdGlvbiAoKSB7XG4gIHZhciBlbWFpbCA9ICQoJy5vbkxvZ2dlZE91dCBpbnB1dFt0eXBlPVwiZW1haWxcIl0nKS52YWwoKTtcbiAgdmFyIHBhc3N3b3JkID0gJCgnLm9uTG9nZ2VkT3V0IGlucHV0W3R5cGU9XCJwYXNzd29yZFwiXScpLnZhbCgpO1xuXG4gIGRvTG9naW4oZW1haWwsIHBhc3N3b3JkLCBmdW5jdGlvbiAoKSB7XG4gICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICB9KTtcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbn0pO1xuXG5mdW5jdGlvbiBjbGVhckZvcm1zICgpIHtcbiAgJCgnaW5wdXRbdHlwZT1cInRleHRcIl0sIGlucHV0W3R5cGU9XCJlbWFpbFwiXSwgaW5wdXRbdHlwZT1cInBhc3N3b3JkXCJdLCBpbnB1dFt0eXBlPVwidXJsXCJdJykudmFsKCcnKTtcbn1cblxuZnVuY3Rpb24gc2F2ZUF1dGhEYXRhIChhdXRoRGF0YSkge1xuICAkLmFqYXgoe1xuICAgIG1ldGhvZDogJ1BVVCcsXG4gICAgdXJsOiBgJHtGSVJFQkFTRV9VUkx9L3VzZXJzLyR7YXV0aERhdGEudWlkfS9wcm9maWxlLmpzb24/YXV0aD0ke2F1dGhEYXRhLnRva2VufWAsXG4gICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoYXV0aERhdGEpXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBkb0xvZ2luIChlbWFpbCwgcGFzc3dvcmQsIGNiKSB7XG4gIGZiLmF1dGhXaXRoUGFzc3dvcmQoe1xuICAgIGVtYWlsOiBlbWFpbCxcbiAgICBwYXNzd29yZDogcGFzc3dvcmRcbiAgfSwgZnVuY3Rpb24gKGVyciwgYXV0aERhdGEpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBhbGVydChlcnIudG9TdHJpbmcoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNhdmVBdXRoRGF0YShhdXRoRGF0YSk7XG4gICAgICB0eXBlb2YgY2IgPT09ICdmdW5jdGlvbicgJiYgY2IoYXV0aERhdGEpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdldFVzZXJEYXRhIChjYikge1xuICB2YXIgdWlkID0gZmIuZ2V0QXV0aCgpLnVpZDtcbiAgdmFyIHRva2VuID0gZmIuZ2V0QXV0aCgpLnRva2VuO1xuICB2YXIgZ2V0VXJsID0gYCR7RklSRUJBU0VfVVJMfS91c2Vycy8ke3VpZH0vZm90b3MuanNvbj9hdXRoPSR7dG9rZW59YDtcbiAgJC5nZXQoZ2V0VXJsLCBjYik7XG59XG5cbmZ1bmN0aW9uIGFkZFBob3Rvc1RvRG9tIChwaG90b3MpIHtcbiAgaWYgKHBob3Rvcykge1xuICAgIE9iamVjdC5rZXlzKHBob3RvcykuZm9yRWFjaChmdW5jdGlvbiAodXVpZCl7XG4gICAgXHQkKGA8aW1nIHNyYz1cIiR7cGhvdG9zW3V1aWRdfVwiIGRhdGEtdWlkPVwiJHt1dWlkfVwiPmApLmFwcGVuZFRvKCQoJy5mYXZGb3RvcycpKTtcbiAgXHR9KVxuICB9XG59XG5cbmZiLm9uQXV0aChmdW5jdGlvbiAoYXV0aERhdGEpIHtcbiAgaWYgKGluaXRMb2FkKSB7XG4gICAgdmFyIG9uTG9nZ2VkT3V0ID0gJCgnLm9uTG9nZ2VkT3V0Jyk7XG4gICAgdmFyIG9uTG9nZ2VkSW4gPSAkKCcub25Mb2dnZWRJbicpO1xuICAgIHZhciBvblRlbXBQYXNzd29yZCA9ICQoJy5vblRlbXBQYXNzd29yZCcpO1xuXG4gICAgaWYgKGF1dGhEYXRhICYmIGF1dGhEYXRhLnBhc3N3b3JkLmlzVGVtcG9yYXJ5UGFzc3dvcmQpIHtcbiAgICAgIC8vIHRlbXBvcmFyeSBsb2cgaW5cbiAgICAgIG9uVGVtcFBhc3N3b3JkLnJlbW92ZUNsYXNzKCdoaWRkZW4nKTtcbiAgICAgIG9uTG9nZ2VkSW4uYWRkQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgb25Mb2dnZWRPdXQuYWRkQ2xhc3MoJ2hpZGRlbicpO1xuICAgIH0gZWxzZSBpZiAoYXV0aERhdGEpIHtcbiAgICAgIC8vIGxvZ2dlZCBpblxuICAgICAgb25Mb2dnZWRJbi5yZW1vdmVDbGFzcygnaGlkZGVuJyk7XG4gICAgICBvbkxvZ2dlZE91dC5hZGRDbGFzcygnaGlkZGVuJyk7XG4gICAgICBvblRlbXBQYXNzd29yZC5hZGRDbGFzcygnaGlkZGVuJyk7XG4gICAgICAkKCcub25Mb2dnZWRJbiBoMScpLnRleHQoYEhlbGxvICR7YXV0aERhdGEucGFzc3dvcmQuZW1haWx9YCk7XG4gICAgICBnZXRVc2VyRGF0YShmdW5jdGlvbiAodXJscykge1xuICAgICAgICBhZGRQaG90b3NUb0RvbSh1cmxzKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBvbiBsb2dnZWQgb3V0XG4gICAgICBvbkxvZ2dlZE91dC5yZW1vdmVDbGFzcygnaGlkZGVuJyk7XG4gICAgICBvbkxvZ2dlZEluLmFkZENsYXNzKCdoaWRkZW4nKTtcbiAgICAgIG9uVGVtcFBhc3N3b3JkLmFkZENsYXNzKCdoaWRkZW4nKTtcbiAgICB9XG4gIFxuICBcdGNsZWFyRm9ybXMoKTtcbiAgfVxuICBcbiAgaW5pdExvYWQgPSBmYWxzZTtcbn0pO1xuIl19
