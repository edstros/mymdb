'use strict';

var FIREBASE_URL = 'https://eamdb.firebaseio.com/';
var fb = new Firebase(FIREBASE_URL);
var initLoad = true;

$('.onLoggedIn form').submit(function () {
  var url = $('.onLoggedIn input[type="url"]').val();
  var uid = fb.getAuth().uid;
  var token = fb.getAuth().token;
  var postUrl = '' + FIREBASE_URL + 'users/' + uid + '/movies.json?auth=' + token;

  $.post(postUrl, JSON.stringify(url), function (res) {
    addPhotosToDom({ url: url });
    clearForms();
    // res = { name: '-Jk4dfDd123' }
  });

  event.preventDefault();
});

$('.onTempPassword form').submit(function () {
  var email = fb.getAuth().password.email;
  var oldPw = $('.onTempPassword input:nth-child(1)').val();
  var newPw = $('.onTempPassword input:nth-child(2)').val();

  fb.changePassword({
    email: email,
    oldPassword: oldPw,
    newPassword: newPw
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      fb.unauth();
    }
  });

  event.preventDefault();
});

$('.doResetPassword').click(function () {
  var email = $('.onLoggedOut input[type="email"]').val();

  fb.resetPassword({
    email: email
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      alert('Check your email!');
    }
  });
});

$('.doLogout').click(function () {
  fb.unauth(function () {
    window.location.reload();
  });
});

$('.goToMovies').click(function () {
  window.location = 'movies.html';
});

$('.doRegister').click(function () {
  var email = $('.onLoggedOut input[type="email"]').val();
  var password = $('.onLoggedOut input[type="password"]').val();

  fb.createUser({
    email: email,
    password: password
  }, function (err, userData) {
    if (err) {
      alert(err.toString());
    } else {
      clearForms();
      doLogin(email, password, function () {
        window.location.reload();
      });
    }
  });

  event.preventDefault();
});

$('.onLoggedOut form').submit(function () {
  var email = $('.onLoggedOut input[type="email"]').val();
  var password = $('.onLoggedOut input[type="password"]').val();

  doLogin(email, password, function () {
    window.location.reload();
  });
  event.preventDefault();
});

function clearForms() {
  $('input[type="text"], input[type="email"], input[type="password"], input[type="url"]').val('');
}

function saveAuthData(authData) {
  $.ajax({
    method: 'PUT',
    url: '' + FIREBASE_URL + '/users/' + authData.uid + '/profile.json?auth=' + authData.token,
    data: JSON.stringify(authData)
  });
}

function doLogin(email, password, cb) {
  fb.authWithPassword({
    email: email,
    password: password
  }, function (err, authData) {
    if (err) {
      alert(err.toString());
    } else {
      saveAuthData(authData);
      typeof cb === 'function' && cb(authData);
    }
  });
}

function getUserData(cb) {
  var uid = fb.getAuth().uid;
  var token = fb.getAuth().token;
  var getUrl = '' + FIREBASE_URL + '/users/' + uid + '/movies.json?auth=' + token;
  $.get(getUrl, cb);
}

function addPhotosToDom(photos) {
  if (photos) {
    Object.keys(photos).forEach(function (uuid) {
      $('<img src="' + photos[uuid] + '" data-uid="' + uuid + '">').appendTo($('.favFotos'));
    });
  }
}

fb.onAuth(function (authData) {
  if (initLoad) {
    var onLoggedOut = $('.onLoggedOut');
    var onLoggedIn = $('.onLoggedIn');
    var onTempPassword = $('.onTempPassword');

    if (authData && authData.password.isTemporaryPassword) {
      // temporary log in
      onTempPassword.removeClass('hidden');
      onLoggedIn.addClass('hidden');
      onLoggedOut.addClass('hidden');
    } else if (authData) {
      // logged in
      onLoggedIn.removeClass('hidden');
      onLoggedOut.addClass('hidden');
      onTempPassword.addClass('hidden');
      $('.onLoggedIn h1').text('Hello ' + authData.password.email);
      getUserData(function (urls) {
        addPhotosToDom(urls);
      });
    } else {
      // on logged out
      onLoggedOut.removeClass('hidden');
      onLoggedIn.addClass('hidden');
      onTempPassword.addClass('hidden');
    }

    clearForms();
  }

  initLoad = false;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9qcy9maXJlYmFzZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBRWIsSUFBSSxZQUFZLEdBQUcsK0JBQStCLENBQUM7QUFDbkQsSUFBSSxFQUFFLEdBQUcsSUFBSSxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDcEMsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDOztBQUVwQixDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWTtBQUN2QyxNQUFJLEdBQUcsR0FBRyxDQUFDLENBQUMsK0JBQStCLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUNuRCxNQUFJLEdBQUcsR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxDQUFDO0FBQzNCLE1BQUksS0FBSyxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUM7QUFDL0IsTUFBSSxPQUFPLFFBQU0sWUFBWSxjQUFTLEdBQUcsMEJBQXFCLEtBQUssQUFBRSxDQUFDOztBQUd0RSxHQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFLFVBQVUsR0FBRyxFQUFFO0FBQ2xELGtCQUFjLENBQUMsRUFBQyxHQUFHLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQztBQUMzQixjQUFVLEVBQUUsQ0FBQzs7R0FFZCxDQUFDLENBQUM7O0FBRUgsT0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO0NBQ3hCLENBQUMsQ0FBQTs7QUFFRixDQUFDLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWTtBQUMzQyxNQUFJLEtBQUssR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztBQUN4QyxNQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsb0NBQW9DLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUMxRCxNQUFJLEtB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QUM7S0FDSixNQUFNOztBQUVMLGlCQUFXLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2xDLGdCQUFVLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzlCLG9CQUFjLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQ25DOztBQUVGLGNBQVUsRUFBRSxDQUFDO0dBQ2I7O0FBRUQsVUFBUSxHQUFHLEtBQUssQ0FBQztDQUNsQixDQUFDLENBQUMiLCJmaWxlIjoiZmlyZWJhc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnZhciBGSVJFQkFTRV9VUkwgPSAnaHR0cHM6Ly9lYW1kYi5maXJlYmFzZWlvLmNvbS8nO1xudmFyIGZiID0gbmV3IEZpcmViYXNlKEZJUkVCQVNFX1VSTCk7XG52YXIgaW5pdExvYWQgPSB0cnVlO1xuXG4kKCcub25Mb2dnZWRJbiBmb3JtJykuc3VibWl0KGZ1bmN0aW9uICgpIHtcbiAgdmFyIHVybCA9ICQoJy5vbkxvZ2dlZEluIGlucHV0W3R5cGU9XCJ1cmxcIl0nKS52YWwoKTtcbiAgdmFyIHVpZCA9IGZiLmdldEF1dGgoKS51aWQ7XG4gIHZhciB0b2tlbiA9IGZiLmdldEF1dGgoKS50b2tlbjtcbiAgdmFyIHBvc3RVcmwgPSBgJHtGSVJFQkFTRV9VUkx9dXNlcnMvJHt1aWR9L21vdmllcy5qc29uP2F1dGg9JHt0b2tlbn1gO1xuXG5cbiAgJC5wb3N0KHBvc3RVcmwsIEpTT04uc3RyaW5naWZ5KHVybCksIGZ1bmN0aW9uIChyZXMpIHtcbiAgICBhZGRQaG90b3NUb0RvbSh7dXJsOiB1cmx9KTtcbiAgICBjbGVhckZvcm1zKCk7XG4gICAgLy8gcmVzID0geyBuYW1lOiAnLUprNGRmRGQxMjMnIH1cbiAgfSk7XG5cbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbn0pXG5cbiQoJy5vblRlbXBQYXNzd29yZCBmb3JtJykuc3VibWl0KGZ1bmN0aW9uICgpIHtcbiAgdmFyIGVtYWlsID0gZmIuZ2V0QXV0aCgpLnBhc3N3b3JkLmVtYWlsO1xuICB2YXIgb2xkUHcgPSAkKCcub25UZW1wUGFzc3dvcmQgaW5wdXQ6bnRoLWNoaWxkKDEpJykudmFsKCk7XG4gIHZhciBuZXdQdyA9ICQoJy5vblRlbXBQYXNzd29yZCBpbnB1dDpudGgtY2hpbGQoMiknKS52YWwoKTtcblxuICBmYi5jaGFuZ2VQYXNzd29yZCh7XG4gICAgZW1haWw6IGVtYWlsLFxuICAgIG9sZFBhc3N3b3JkOiBvbGRQdyxcbiAgICBuZXdQYXNzd29yZDogbmV3UHdcbiAgfSwgZnVuY3Rpb24oZXJyKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgYWxlcnQoZXJyLnRvU3RyaW5nKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBmYi51bmF1dGgoKTtcbiAgICB9XG4gIH0pO1xuXG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG59KVxuXG4kKCcuZG9SZXNldFBhc3N3b3JkJykuY2xpY2soZnVuY3Rpb24gKCkge1xuICB2YXIgZW1haWwgPSAkKCcub25Mb2dnZWRPdXQgaW5wdXRbdHlwZT1cImVtYWlsXCJdJykudmFsKCk7XG5cbiAgZmIucmVzZXRQYXNzd29yZCh7XG4gICAgZW1haWw6IGVtYWlsXG4gIH0sIGZ1bmN0aW9uIChlcnIpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBhbGVydChlcnIudG9TdHJpbmcoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFsZXJ0KCdDaGVjayB5b3VyIGVtYWlsIScpO1xuICAgIH1cbiAgfSk7XG59KTtcblxuJCgnLmRvTG9nb3V0JykuY2xpY2soZnVuY3Rpb24gKCkge1xuICBmYi51bmF1dGgoZnVuY3Rpb24gKCkge1xuICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTtcbiAgfSk7XG59KVxuXG4kKFwiLmdvVG9Nb3ZpZXNcIikuY2xpY2soZnVuY3Rpb24oKSB7XG4gICAgd2luZG93LmxvY2F0aW9uID0gXCJtb3ZpZXMuaHRtbFwiO1xufSk7XG5cblxuJCgnLmRvUmVnaXN0ZXInKS5jbGljayhmdW5jdGlvbiAoKSB7XG4gIHZhciBlbWFpbCA9ICQoJy5vbkxvZ2dlZE91dCBpbnB1dFt0eXBlPVwiZW1haWxcIl0nKS52YWwoKTtcbiAgdmFyIHBhc3N3b3JkID0gJCgnLm9uTG9nZ2VkT3V0IGlucHV0W3R5cGU9XCJwYXNzd29yZFwiXScpLnZhbCgpO1xuXG4gIGZiLmNyZWF0ZVVzZXIoe1xuICAgIGVtYWlsOiBlbWFpbCxcbiAgICBwYXNzd29yZDogcGFzc3dvcmRcbiAgfSwgZnVuY3Rpb24gKGVyciwgdXNlckRhdGEpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBhbGVydChlcnIudG9TdHJpbmcoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNsZWFyRm9ybXMoKTtcbiAgICAgIGRvTG9naW4oZW1haWwsIHBhc3N3b3JkLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbn0pO1xuXG4kKCcub25Mb2dnZWRPdXQgZm9ybScpLnN1Ym1pdChmdW5jdGlvbiAoKSB7XG4gIHZhciBlbWFpbCA9ICQoJy5vbkxvZ2dlZE91dCBpbnB1dFt0eXBlPVwiZW1haWxcIl0nKS52YWwoKTtcbiAgdmFyIHBhc3N3b3JkID0gJCgnLm9uTG9nZ2VkT3V0IGlucHV0W3R5cGU9XCJwYXNzd29yZFwiXScpLnZhbCgpO1xuXG4gIGRvTG9naW4oZW1haWwsIHBhc3N3b3JkLCBmdW5jdGlvbiAoKSB7XG4gICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICB9KTtcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbn0pO1xuXG5mdW5jdGlvbiBjbGVhckZvcm1zICgpIHtcbiAgJCgnaW5wdXRbdHlwZT1cInRleHRcIl0sIGlucHV0W3R5cGU9XCJlbWFpbFwiXSwgaW5wdXRbdHlwZT1cInBhc3N3b3JkXCJdLCBpbnB1dFt0eXBlPVwidXJsXCJdJykudmFsKCcnKTtcbn1cblxuZnVuY3Rpb24gc2F2ZUF1dGhEYXRhIChhdXRoRGF0YSkge1xuICAkLmFqYXgoe1xuICAgIG1ldGhvZDogJ1BVVCcsXG4gICAgdXJsOiBgJHtGSVJFQkFTRV9VUkx9L3VzZXJzLyR7YXV0aERhdGEudWlkfS9wcm9maWxlLmpzb24/YXV0aD0ke2F1dGhEYXRhLnRva2VufWAsXG4gICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoYXV0aERhdGEpXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBkb0xvZ2luIChlbWFpbCwgcGFzc3dvcmQsIGNiKSB7XG4gIGZiLmF1dGhXaXRoUGFzc3dvcmQoe1xuICAgIGVtYWlsOiBlbWFpbCxcbiAgICBwYXNzd29yZDogcGFzc3dvcmRcbiAgfSwgZnVuY3Rpb24gKGVyciwgYXV0aERhdGEpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBhbGVydChlcnIudG9TdHJpbmcoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNhdmVBdXRoRGF0YShhdXRoRGF0YSk7XG4gICAgICB0eXBlb2YgY2IgPT09ICdmdW5jdGlvbicgJiYgY2IoYXV0aERhdGEpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdldFVzZXJEYXRhIChjYikge1xuICB2YXIgdWlkID0gZmIuZ2V0QXV0aCgpLnVpZDtcbiAgdmFyIHRva2VuID0gZmIuZ2V0QXV0aCgpLnRva2VuO1xuICB2YXIgZ2V0VXJsID0gYCR7RklSRUJBU0VfVVJMfS91c2Vycy8ke3VpZH0vbW92aWVzLmpzb24/YXV0aD0ke3Rva2VufWA7XG4gICQuZ2V0KGdldFVybCwgY2IpO1xufVxuXG5mdW5jdGlvbiBhZGRQaG90b3NUb0RvbSAocGhvdG9zKSB7XG4gIGlmIChwaG90b3MpIHtcbiAgICBPYmplY3Qua2V5cyhwaG90b3MpLmZvckVhY2goZnVuY3Rpb24gKHV1aWQpe1xuICAgIFx0JChgPGltZyBzcmM9XCIke3Bob3Rvc1t1dWlkXX1cIiBkYXRhLXVpZD1cIiR7dXVpZH1cIj5gKS5hcHBlbmRUbygkKCcuZmF2Rm90b3MnKSk7XG4gIFx0fSlcbiAgfVxufVxuXG5mYi5vbkF1dGgoZnVuY3Rpb24gKGF1dGhEYXRhKSB7XG4gIGlmIChpbml0TG9hZCkge1xuICAgIHZhciBvbkxvZ2dlZE91dCA9ICQoJy5vbkxvZ2dlZE91dCcpO1xuICAgIHZhciBvbkxvZ2dlZEluID0gJCgnLm9uTG9nZ2VkSW4nKTtcbiAgICB2YXIgb25UZW1wUGFzc3dvcmQgPSAkKCcub25UZW1wUGFzc3dvcmQnKTtcblxuICAgIGlmIChhdXRoRGF0YSAmJiBhdXRoRGF0YS5wYXNzd29yZC5pc1RlbXBvcmFyeVBhc3N3b3JkKSB7XG4gICAgICAvLyB0ZW1wb3JhcnkgbG9nIGluXG4gICAgICBvblRlbXBQYXNzd29yZC5yZW1vdmVDbGFzcygnaGlkZGVuJyk7XG4gICAgICBvbkxvZ2dlZEluLmFkZENsYXNzKCdoaWRkZW4nKTtcbiAgICAgIG9uTG9nZ2VkT3V0LmFkZENsYXNzKCdoaWRkZW4nKTtcbiAgICB9IGVsc2UgaWYgKGF1dGhEYXRhKSB7XG4gICAgICAvLyBsb2dnZWQgaW5cbiAgICAgIG9uTG9nZ2VkSW4ucmVtb3ZlQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgb25Mb2dnZWRPdXQuYWRkQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgb25UZW1wUGFzc3dvcmQuYWRkQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgJCgnLm9uTG9nZ2VkSW4gaDEnKS50ZXh0KGBIZWxsbyAke2F1dGhEYXRhLnBhc3N3b3JkLmVtYWlsfWApO1xuICAgICAgZ2V0VXNlckRhdGEoZnVuY3Rpb24gKHVybHMpIHtcbiAgICAgICAgYWRkUGhvdG9zVG9Eb20odXJscyk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gb24gbG9nZ2VkIG91dFxuICAgICAgb25Mb2dnZWRPdXQucmVtb3ZlQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgb25Mb2dnZWRJbi5hZGRDbGFzcygnaGlkZGVuJyk7XG4gICAgICBvblRlbXBQYXNzd29yZC5hZGRDbGFzcygnaGlkZGVuJyk7XG4gICAgfVxuXG4gIFx0Y2xlYXJGb3JtcygpO1xuICB9XG5cbiAgaW5pdExvYWQgPSBmYWxzZTtcbn0pO1xuIl19
